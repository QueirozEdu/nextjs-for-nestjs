"use server";

import {
    CreateUserSchema,
    PublicUserDto,
    PublicUserSchema,
} from "@/lib/user/schemas";
import { asyncDelay } from "@/utils/async-delay";
import { getZodErrorMessages } from "@/utils/get-zod-error-messages";

type CreateUserActionState = {
    user: PublicUserDto;
    errors: string[];
    success: boolean;
};

export async function createUserAction(
    state: CreateUserActionState,
    formData: FormData
): Promise<CreateUserActionState> {
    await asyncDelay(2000);
    if (!(formData instanceof FormData)) {
        return {
            user: state.user,
            errors: ["Invalid data"],
            success: false,
        };
    }

    const formObj = Object.fromEntries(formData.entries());
    const parsedFormData = CreateUserSchema.safeParse(formObj);

    if (!parsedFormData.success) {
        return {
            user: PublicUserSchema.parse(formObj),
            errors: getZodErrorMessages(parsedFormData.error.format()),
            success: false,
        };
    }

    //TODO fetch API
    return {
        user: state.user,
        errors: [],
        success: true,
    };
}
